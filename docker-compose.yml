version: "3.7"

x-buildargs: &build_args
  GIT_COMMIT: ${GIT_COMMIT:-'git-commit'}
  BUILD_VERSION: ${GITVERSION_SEMVER:-'semver'}

services:
  web:
    image: ${CR_BASE:-local}/web:${GITVERSION_SEMVER:-latest}
    build:
      context: ./web/
      args:
        <<: *build_args
    ports: ["7080:80"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nsctool-web.rule=Host(`web.${HOST:-localhost}`)"
      - "traefik.http.routers.nsctool-web.entrypoints=web"
    networks:
      - "nsctool"

  api:
    image: ${CR_BASE:-local}/api:${GITVERSION_SEMVER:-latest}
    build: 
      context: ./api/
      args:
        <<: *build_args
    ports: ["7090:8080"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nsctool-api.rule=Host(`api.${HOST:-localhost}`)"
      - "traefik.http.routers.nsctool-api.entrypoints=web"
    networks:
      - "nsctool"

networks:
  nsctool:
    external: true
